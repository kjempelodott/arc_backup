<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link REL="SHORTCUT ICON" HREF="http//www.nordugrid.org/favicon.ico">
    <link rel="STYLESHEET" href="../../../_static/pygments.css" type="text/css" />
    <link rel="STYLESHEET" href="../../../_static/nordugrid_wrapper.css" type="text/css" />
    <title>NorduGrid | Python LRMS backends</title>
  </head>
  
  <body class="LONG">
    <div class="MAIN">
      <h1 class="TITLE">Python LRMS backends</h1>
      
      <h1>Source code for lrms.common.submit</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Common submit job functions.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">arc</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">proc</span> <span class="kn">import</span> <span class="n">execute_local</span><span class="p">,</span> <span class="n">execute_remote</span>
<span class="kn">from</span> <span class="nn">files</span> <span class="kn">import</span> <span class="n">write</span>
<span class="kn">from</span> <span class="nn">log</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="validate_attributes"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.validate_attributes">[docs]</a><span class="k">def</span> <span class="nf">validate_attributes</span><span class="p">(</span><span class="n">jd</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Checks if GRID (global) job ID and executable are set in job description</span>
<span class="sd">     and that runtime environment is resolved. For none-shared filesystems, </span>
<span class="sd">     the scratchdir must also be specified.</span>

<span class="sd">     :param jd: job description object</span>
<span class="sd">     :type jd: :py:class:`arc.JobDescription`</span>
<span class="sd">     &quot;&quot;&quot;</span>
  
     <span class="k">if</span> <span class="s">&#39;joboption;gridid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">ArcError</span><span class="p">(</span><span class="s">&#39;Grid ID not specified&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
     
     <span class="k">if</span> <span class="s">&#39;joboption;directory&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">:</span>
          <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;directory&#39;</span><span class="p">]</span> <span class="o">=</span> \
              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">sessiondir</span><span class="p">,</span> <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;gridid&#39;</span><span class="p">])</span>

     <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;local_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;directory&#39;</span><span class="p">]</span>

     <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">remote_sessiondir</span><span class="p">:</span>
          <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;directory&#39;</span><span class="p">]</span> <span class="o">=</span> \
              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">remote_sessiondir</span><span class="p">,</span> <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;gridid&#39;</span><span class="p">])</span>
          <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Output</span> <span class="o">=</span> <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">sessiondir</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">remote_sessiondir</span><span class="p">)</span>
          <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Input</span> <span class="o">=</span> <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Input</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">sessiondir</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">remote_sessiondir</span><span class="p">)</span>
          <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Error</span> <span class="o">=</span> <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Error</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">sessiondir</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">remote_sessiondir</span><span class="p">)</span>

     <span class="k">if</span> <span class="s">&#39;joboption;controldir&#39;</span> <span class="ow">in</span> <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">:</span>
          <span class="n">Config</span><span class="o">.</span><span class="n">controldir</span> <span class="o">=</span> <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;controldir&#39;</span><span class="p">]</span>
     <span class="k">if</span> <span class="ow">not</span> <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Executable</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">ArcError</span><span class="p">(</span><span class="s">&#39;Executable is not specified&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
     <span class="k">if</span> <span class="ow">not</span> <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">RunTimeEnvironment</span><span class="o">.</span><span class="n">isResolved</span><span class="p">():</span>
          <span class="k">raise</span> <span class="n">ArcError</span><span class="p">(</span><span class="s">&#39;Run-time Environment not satisfied&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
     <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="o">.</span><span class="n">shared_filesystem</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Config</span><span class="o">.</span><span class="n">scratchdir</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">ArcError</span><span class="p">(</span><span class="s">&#39;Need to know at which directory to run job: &#39;</span>
                         <span class="s">&#39;RUNTIME_LOCAL_SCRATCH_DIR must be set if &#39;</span>
                         <span class="s">&#39;RUNTIME_NODE_SEES_FRONTEND is empty&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>

     <span class="n">has_globalid</span> <span class="o">=</span> <span class="bp">False</span>
     <span class="k">for</span> <span class="n">env_pair</span> <span class="ow">in</span> <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Environment</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">env_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;GRID_GLOBAL_JOBID&#39;</span><span class="p">:</span>
               <span class="n">has_globalid</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="k">break</span>
     <span class="k">if</span> <span class="ow">not</span> <span class="n">has_globalid</span><span class="p">:</span>
          <span class="n">globalid</span> <span class="o">=</span> <span class="s">&#39;gsiftp://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">gm_port</span><span class="p">,</span>
                                              <span class="n">Config</span><span class="o">.</span><span class="n">gm_mount_point</span><span class="p">,</span> <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;gridid&#39;</span><span class="p">])</span>
          <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Environment</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;GRID_GLOBAL_JOBID&#39;</span><span class="p">,</span> <span class="n">globalid</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="write_script_file"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.write_script_file">[docs]</a><span class="k">def</span> <span class="nf">write_script_file</span><span class="p">(</span><span class="n">jobscript</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Write job script to file.</span>

<span class="sd">     :param str jobscript: job script buffer</span>
<span class="sd">     :return: path to file</span>
<span class="sd">     :rtype: :py:obj:`str`</span>
<span class="sd">     &quot;&quot;&quot;</span>
     
     <span class="kn">import</span> <span class="nn">uuid</span><span class="o">,</span> <span class="nn">stat</span>

     <span class="n">jobscript</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">rm -- &quot;$0&quot;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="c"># self destroy</span>
     <span class="n">mode</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span>

     <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/tmp/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="o">+</span> <span class="s">&#39;.sh&#39;</span>

     <span class="k">if</span> <span class="ow">not</span> <span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">jobscript</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">remote_host</span><span class="p">):</span>
          <span class="k">raise</span> <span class="n">ArcError</span><span class="p">(</span><span class="s">&#39;Failed to write jobscript&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>

     <span class="k">return</span> <span class="n">path</span>

</div>
<div class="viewcode-block" id="set_req_mem"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.set_req_mem">[docs]</a><span class="k">def</span> <span class="nf">set_req_mem</span><span class="p">(</span><span class="n">jd</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Set memory requirement attributes in job description.</span>

<span class="sd">   :param jd: job description object</span>
<span class="sd">   :type jd: :py:class:`arc.JobDescription`</span>
<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">if</span> <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">IndividualPhysicalMemory</span><span class="o">.</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
       <span class="n">nodememory</span> <span class="o">=</span> <span class="mi">0</span>
       <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">defaultmemory</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">QueueName</span> <span class="ow">in</span> <span class="n">Config</span><span class="o">.</span><span class="n">queue</span>
               <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">QueueName</span><span class="p">],</span> <span class="s">&#39;nodememory&#39;</span><span class="p">)):</span>
                <span class="n">nodememory</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">QueueName</span><span class="p">]</span><span class="o">.</span><span class="n">nodememory</span>
           <span class="k">elif</span> <span class="n">Config</span><span class="o">.</span><span class="n">nodememory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nodememory</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">nodememory</span>

       <span class="n">debug</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">69</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
       <span class="n">debug</span><span class="p">(</span><span class="s">&#39;WARNING: The job description contains no explicit memory requirement.&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">defaultmemory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
           <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">IndividualPhysicalMemory</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">defaultmemory</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         A default memory limit taken from </span><span class="se">\&#39;</span><span class="s">defaultmemory</span><span class="se">\&#39;</span><span class="s"> in&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         arc.conf will apply.&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         Limit is: </span><span class="si">%s</span><span class="s"> mb.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">defaultmemory</span><span class="p">),</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
       <span class="k">elif</span> <span class="n">nodememory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
           <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">IndividualPhysicalMemory</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">nodememory</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         A default memory limit taken from </span><span class="se">\&#39;</span><span class="s">nodememory</span><span class="se">\&#39;</span><span class="s"> in&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         arc.conf will apply.&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         You may want to set </span><span class="se">\&#39;</span><span class="s">defaultmemory</span><span class="se">\&#39;</span><span class="s"> to something&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         else in arc.conf to better handle jobs with no memory&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         specified.&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         Limit is: </span><span class="si">%s</span><span class="s"> mb.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nodememory</span><span class="p">),</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">IndividualPhysicalMemory</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1000</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         nodememory is not specified in arc.conf. A default&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         memory limit of 1GB will apply.&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
       <span class="n">debug</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">69</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>

   <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">localtransfer</span> <span class="ow">and</span> <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">IndividualPhysicalMemory</span><span class="o">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
       <span class="n">debug</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">69</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
       <span class="n">debug</span><span class="p">(</span><span class="s">&#39;WARNING: localtransfers are enabled and job has less than 1GB of&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
       <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         ram. up- and downloaders take up a lot of ram,&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
       <span class="n">debug</span><span class="p">(</span><span class="s">&#39;         this can give you problems.&#39;</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
       <span class="n">debug</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">69</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>


<span class="c"># Limitation: In RTE stage 0, scripts MUST use the &#39;export&#39; command if any</span>
<span class="c"># new variables are defined which should be picked up by the submit script.</span>
<span class="c"># Also no output from the RTE script in stage 0 will be printed.</span></div>
<div class="viewcode-block" id="RTE_stage0"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.RTE_stage0">[docs]</a><span class="k">def</span> <span class="nf">RTE_stage0</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">lrms</span><span class="p">,</span> <span class="o">**</span><span class="n">mapping</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Source RTE scripts and update job description environment.</span>

<span class="sd">   :param jd: job description object</span>
<span class="sd">   :type jd: :py:class:`arc.JobDescription`</span>
<span class="sd">   :param dict **mapping: additional environment variables</span>
<span class="sd">   &quot;&quot;&quot;</span>     

   <span class="k">if</span> <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">RunTimeEnvironment</span><span class="o">.</span><span class="n">getSoftwareList</span><span class="p">():</span>
        <span class="kn">from</span> <span class="nn">parse</span> <span class="kn">import</span> <span class="n">RTE0EnvCreator</span>
        <span class="n">envCreator</span> <span class="o">=</span> <span class="n">RTE0EnvCreator</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">Config</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
        <span class="n">stage0_environ</span> <span class="o">=</span> <span class="n">envCreator</span><span class="o">.</span><span class="n">getShEnv</span><span class="p">()</span>
        <span class="n">stage0_environ</span><span class="p">[</span><span class="s">&#39;joboption_lrms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lrms</span>

        <span class="c"># Source RTE script and update the RTE stage0 dict</span>
        <span class="k">def</span> <span class="nf">source_sw</span><span class="p">(</span><span class="n">sw</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">runtimedir</span><span class="p">,</span> <span class="n">sw</span><span class="p">)):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s">&#39;sourcewithargs () { script=$1; shift; . $script;}; sourcewithargs </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s"> 0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">runtimedir</span><span class="p">,</span> <span class="n">sw</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">+=</span> <span class="s">&#39; &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&quot;&#39;</span><span class="p">))</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="s">&#39; &gt; /dev/null 2&gt;&amp;1 &amp;&amp; env&#39;</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">execute_local</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">stage0_environ</span><span class="p">)</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">stdout</span>
                <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                     <span class="k">raise</span> <span class="n">ArcError</span><span class="p">(</span><span class="s">&#39;Runtime script </span><span class="si">%s</span><span class="s"> failed&#39;</span> <span class="o">%</span> <span class="n">sw</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
                <span class="n">new_env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">stdout</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
                <span class="n">stage0_environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_env</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s">&#39;Runtime script </span><span class="si">%s</span><span class="s"> is missing&#39;</span> <span class="o">%</span> <span class="n">sw</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>
                <span class="c">#should we exit here?</span>

        <span class="c"># Source RTE scripts from the software list</span>
        <span class="n">sw_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">RunTimeEnvironment</span><span class="o">.</span><span class="n">getSoftwareList</span><span class="p">():</span>
            <span class="n">sw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sw</span><span class="p">))</span>
            <span class="n">source_sw</span><span class="p">(</span><span class="n">sw</span><span class="p">,</span> <span class="n">sw</span><span class="o">.</span><span class="n">getOptions</span><span class="p">())</span>

        <span class="c"># Source new RTE scripts set by the previous step (if any)</span>
        <span class="n">rte_environ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">stage0_environ</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;joboption_runtime_\d+&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="n">rte_environ_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">stage0_environ</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;joboption_runtime_\d+_\d+&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">rte_environ</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sw_list</span><span class="p">):</span>
           <span class="k">for</span> <span class="n">rte</span><span class="p">,</span> <span class="n">sw</span> <span class="ow">in</span> <span class="n">rte_environ</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
              <span class="k">try</span><span class="p">:</span>
                 <span class="n">i</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;joboption_runtime_(\d+)&#39;</span><span class="p">,</span> <span class="n">rte</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                 <span class="k">if</span> <span class="n">sw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sw_list</span><span class="p">:</span>
                    <span class="n">opts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">rte_</span><span class="p">,</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">rte_environ_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                       <span class="k">try</span><span class="p">:</span>
                          <span class="n">j</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">rte</span> <span class="o">+</span> <span class="s">&#39;_(\d+)&#39;</span><span class="p">,</span> <span class="n">rte_</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                          <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                       <span class="k">except</span><span class="p">:</span>
                          <span class="k">pass</span>
                    <span class="n">source_sw</span><span class="p">(</span><span class="n">sw</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
                    <span class="n">sw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw</span><span class="p">)</span>
              <span class="k">except</span><span class="p">:</span>
                 <span class="k">pass</span>
           <span class="n">rte_environ</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">stage0_environ</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;joboption_runtime_\d+&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
           <span class="n">rte_environ_opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">stage0_environ</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;joboption_runtime_\d+_\d+&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="c"># Update jobdesc</span>
        <span class="n">envCreator</span><span class="o">.</span><span class="n">setPyEnv</span><span class="p">(</span><span class="n">stage0_environ</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;RUNTIME_ENABLE_MULTICORE_SCRATCH&quot;</span> <span class="ow">in</span> <span class="n">stage0_environ</span><span class="p">:</span>
             <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;RUNTIME_ENABLE_MULTICORE_SCRATCH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

   <span class="c"># joboption_count might have been changed by an RTE.</span>
   <span class="c"># Save it for accouting purposes.</span>
   <span class="k">if</span> <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">SlotRequirement</span><span class="o">.</span><span class="n">NumberOfSlots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
       <span class="k">try</span><span class="p">:</span>
           <span class="n">diagfilename</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/job.</span><span class="si">%s</span><span class="s">.diag&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">controldir</span><span class="p">,</span> <span class="n">jd</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;gridid&#39;</span><span class="p">])</span>
           <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">diagfilename</span><span class="p">,</span> <span class="s">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">diagfile</span><span class="p">:</span>
               <span class="n">diagfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;ExecutionUnits=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">jd</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">SlotRequirement</span><span class="o">.</span><span class="n">NumberOfSlots</span><span class="p">)</span>
       <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
           <span class="n">debug</span><span class="p">(</span><span class="s">&#39;Unable to write to diag file (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">diagfilename</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="JobscriptAssembler"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.JobscriptAssembler">[docs]</a><span class="k">class</span> <span class="nc">JobscriptAssembler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Parses and expands the jobscript stubs defined in job_script.stubs.</span>
<span class="sd">     Each stub is initiated by a line starting with &#39;&gt;&gt;&#39;, followed by</span>
<span class="sd">     the name of the stub. The stub must be enclosed within two &#39;&gt;&#39; on</span>
<span class="sd">     separate lines.::</span>

<span class="sd">       &gt;&gt; set_some_vars</span>
<span class="sd">       &gt;</span>
<span class="sd">       export FOO=bar</span>
<span class="sd">       export BAR=baz</span>
<span class="sd">       &gt;</span>


<span class="sd">     To expand variables, use the Python format syntax %(LOCAL)s.::</span>

<span class="sd">       &gt;&gt; set_sessiondir</span>
<span class="sd">       &gt;</span>
<span class="sd">       export RUNTIME_SESSIONDIR=%(SESSIONDIR)s</span>
<span class="sd">       &gt;</span>

<span class="sd">     This will evaluate to the session directory specified in the </span>
<span class="sd">     job description, for example::</span>

<span class="sd">       export RUNTIME_SESSIONDIR=/scratch/grid/123456</span>
<span class="sd">     </span>
<span class="sd">      </span>
<span class="sd">     It is also possible to define loops that depend on some iterable </span>
<span class="sd">     in the job description object. For example, the attribute</span>
<span class="sd">     Application.Environment is an iterable, where each item is a tuple</span>
<span class="sd">     with two elements: name of environment variable and value of </span>
<span class="sd">     environment variable. This is mapped to &#39;ENVS&#39; with macros</span>
<span class="sd">     &#39;ENV&#39; and &#39;ENV_VAL&#39;.</span>

<span class="sd">     Loops must be enclosed within two &#39;@&#39; on separate lines. The top &#39;@&#39;</span>
<span class="sd">     must be followed by the map name of the iterable and the map name </span>
<span class="sd">     of the macro(s) that resolves the string format variables. The </span>
<span class="sd">     simplest macro is mapped to &#39;ITEM&#39; and simply returns the current </span>
<span class="sd">     item in the iterable. This is only applicable when each item is a </span>
<span class="sd">     string. Note the &#39;%&#39; in front of each macro name in the first line</span>
<span class="sd">     following example.::</span>


<span class="sd">         @ ENVS %ENV %ENV_VAL</span>
<span class="sd">         export %(ENV)s=%(ENV_VAL)s</span>
<span class="sd">         @</span>


<span class="sd">     This will evaluate to a list of export lines for every environment </span>
<span class="sd">     variable represented in Application.Environment.</span>


<span class="sd">     All format variables, iterables and macros are defined in the </span>
<span class="sd">     ``map`` attribute.</span>
<span class="sd">     &quot;&quot;&quot;</span>

<div class="viewcode-block" id="JobscriptAssembler.get_standard_jobscript"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.JobscriptAssembler.get_standard_jobscript">[docs]</a>     <span class="k">def</span> <span class="nf">get_standard_jobscript</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Assemble a generic, out-of-the-box jobscript. This does</span>
<span class="sd">          not contain the batch system-specific instructions you</span>
<span class="sd">          typically find at the top of the jobscript.</span>
<span class="sd">          </span>
<span class="sd">          return: jobscript</span>
<span class="sd">          rtype: :py:obj:`str`</span>
<span class="sd">          &quot;&quot;&quot;</span>
          
          <span class="n">script</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;umask_and_sourcewithargs&#39;</span><span class="p">)</span>
          <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;user_env&#39;</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">localtransfer</span><span class="p">:</span>
               <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;local_transfer&#39;</span><span class="p">)</span>
          <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;runtime_env&#39;</span><span class="p">)</span>
          <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;move_files_to_node&#39;</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">localtransfer</span><span class="p">:</span>
               <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;download_input_files&#39;</span><span class="p">)</span>
          <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;rte_stage1&#39;</span><span class="p">)</span>
          <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;cd_and_run&#39;</span><span class="p">)</span>
          <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;rte_stage2&#39;</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">localtransfer</span><span class="p">:</span>
               <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;upload_output_files&#39;</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
               <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;clean_scratchdir&#39;</span><span class="p">)</span>
          <span class="n">script</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stub</span><span class="p">(</span><span class="s">&#39;move_files_to_frontend&#39;</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">script</span>
</div>
<div class="viewcode-block" id="JobscriptAssembler.get_stub"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.JobscriptAssembler.get_stub">[docs]</a>     <span class="k">def</span> <span class="nf">get_stub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stub</span><span class="p">):</span>
          <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Get formatted jobscript stub.</span>

<span class="sd">          param str stub: name of jobscript stub </span>
<span class="sd">          return: jobscript stub</span>
<span class="sd">          rtype: :py:obj:`str`</span>
<span class="sd">          &quot;&quot;&quot;</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stubs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stub</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
     
</div>
     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobdesc</span><span class="p">):</span>

          <span class="bp">self</span><span class="o">.</span><span class="n">jobdesc</span> <span class="o">=</span> <span class="n">jobdesc</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_stubs</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="p">[]</span>
          <span class="c"># String format map</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
               <span class="c"># Simple strings</span>
               <span class="s">&#39;GRIDID&#39;</span>               <span class="p">:</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;gridid&#39;</span><span class="p">],</span>
               <span class="s">&#39;SESSIONDIR&#39;</span>           <span class="p">:</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">OtherAttributes</span><span class="p">[</span><span class="s">&#39;joboption;directory&#39;</span><span class="p">],</span>
               <span class="s">&#39;STDIN&#39;</span>                <span class="p">:</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Input</span><span class="p">,</span>
               <span class="s">&#39;STDOUT&#39;</span>               <span class="p">:</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Output</span><span class="p">,</span>
               <span class="s">&#39;STDERR&#39;</span>               <span class="p">:</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span>
               <span class="s">&#39;STDIN_REDIR&#39;</span>          <span class="p">:</span> <span class="s">&#39;&lt;$RUNTIME_JOB_STDIN&#39;</span> <span class="k">if</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Input</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
               <span class="s">&#39;STDOUT_REDIR&#39;</span>         <span class="p">:</span> <span class="s">&#39;1&gt;$RUNTIME_JOB_STDOUT&#39;</span> <span class="k">if</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Output</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
               <span class="s">&#39;STDERR_REDIR&#39;</span>         <span class="p">:</span> <span class="s">&#39;2&gt;$RUNTIME_JOB_STDERR&#39;</span> <span class="k">if</span> \
                                        <span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Output</span> <span class="o">!=</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Error</span> <span class="k">else</span> <span class="s">&#39;2&gt;&amp;1&#39;</span><span class="p">,</span>
               <span class="s">&#39;EXEC&#39;</span>                 <span class="p">:</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Executable</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> 
               <span class="s">&#39;ARGS&#39;</span>                 <span class="p">:</span> <span class="s">&#39;&quot; &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Executable</span><span class="o">.</span><span class="n">Argument</span><span class="p">)),</span>
               <span class="s">&#39;PROCESSORS&#39;</span>           <span class="p">:</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">SlotRequirement</span><span class="o">.</span><span class="n">NumberOfSlots</span><span class="p">,</span>
               <span class="s">&#39;NODENAME&#39;</span>             <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">nodename</span><span class="p">,</span>
               <span class="s">&#39;GNU_TIME&#39;</span>             <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">gnu_time</span><span class="p">,</span>
               <span class="s">&#39;GM_MOUNTPOINT&#39;</span>        <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">gm_mount_point</span><span class="p">,</span>
               <span class="s">&#39;GM_PORT&#39;</span>              <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">gm_port</span><span class="p">,</span>
               <span class="s">&#39;GM_HOST&#39;</span>              <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
               <span class="s">&#39;LOCAL_SCRATCHDIR&#39;</span>     <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">scratchdir</span><span class="p">,</span> 
               <span class="s">&#39;RUNTIMEDIR&#39;</span>           <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">remote_runtimedir</span> <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">remote_runtimedir</span> <span class="k">else</span> <span class="n">Config</span><span class="o">.</span><span class="n">runtimedir</span><span class="p">,</span>
               <span class="s">&#39;SHARED_SCRATCHDIR&#39;</span>    <span class="p">:</span> <span class="n">Config</span><span class="o">.</span><span class="n">shared_scratch</span><span class="p">,</span> 
               <span class="s">&#39;IS_SHARED_FILESYSTEM&#39;</span> <span class="p">:</span> <span class="s">&#39;yes&#39;</span> <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">shared_filesystem</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
               <span class="s">&#39;ARC_LOCATION&#39;</span>         <span class="p">:</span> <span class="n">arc</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">ArcLocation</span><span class="o">.</span><span class="n">Get</span><span class="p">(),</span>
               <span class="s">&#39;ARC_TOOLSDIR&#39;</span>         <span class="p">:</span> <span class="n">arc</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">ArcLocation</span><span class="o">.</span><span class="n">GetToolsDir</span><span class="p">(),</span>
               <span class="s">&#39;GLOBUS_LOCATION&#39;</span>      <span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;GLOBUS_LOCATION&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
               <span class="c"># Iterables and associated macros</span>
               <span class="s">&#39;ENVS&#39;</span>                 <span class="p">:</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Environment</span><span class="p">,</span> <span class="c"># Iterable</span>
               <span class="s">&#39;ENV&#39;</span>                  <span class="p">:</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="c"># Macro</span>
               <span class="s">&#39;ENV_VAL&#39;</span>              <span class="p">:</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c"># Macro</span>

               <span class="s">&#39;RTES&#39;</span>                 <span class="p">:</span> <span class="n">jobdesc</span><span class="o">.</span><span class="n">Resources</span><span class="o">.</span><span class="n">RunTimeEnvironment</span><span class="o">.</span><span class="n">getSoftwareList</span><span class="p">(),</span> <span class="c"># Iterable</span>
               <span class="s">&#39;RTE&#39;</span>                  <span class="p">:</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="c"># Macro</span>
               <span class="s">&#39;OPTS&#39;</span>                 <span class="p">:</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="s">&#39;&quot; &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">opt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&quot;&#39;</span><span class="p">)</span> <span class="k">for</span>
                                                                          <span class="n">opt</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">getOptions</span><span class="p">()]),</span> <span class="c"># Macro</span>
               <span class="c"># To be setup in a later method</span>
               <span class="s">&#39;RUNTIME_CONTROLDIR&#39;</span>   <span class="p">:</span>	<span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># Setup later if localtransfer</span>
               <span class="s">&#39;OUTPUT_LISTS&#39;</span>         <span class="p">:</span>	<span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># Setup later if NOT localtransfer</span>
               <span class="s">&#39;OUTPUT_FILES&#39;</span>         <span class="p">:</span>	<span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># Setup later if NOT localtransfer</span>
               <span class="s">&#39;ITEM&#39;</span>                 <span class="p">:</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span> <span class="c"># Generic macro</span>
               <span class="p">}</span>

          <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">localtransfer</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">setup_local_transfer</span><span class="p">()</span>
          <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">setup_cleaning</span><span class="p">()</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="o">.</span><span class="n">shared_filesystem</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">setup_runtime_env</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">()</span>


     <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


     <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

          <span class="n">PARSE</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="n">SKIP</span>  <span class="o">=</span> <span class="mi">1</span>
          <span class="n">READ</span>  <span class="o">=</span> <span class="mi">2</span>
          <span class="n">LOOP</span>  <span class="o">=</span> <span class="mi">4</span>

          <span class="n">do</span> <span class="o">=</span> <span class="n">PARSE</span>
          <span class="n">stub_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
          <span class="n">stub</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
          <span class="n">loop</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
          <span class="n">_iterable</span> <span class="o">=</span> <span class="bp">None</span>
          <span class="n">_macros</span> <span class="o">=</span> <span class="bp">None</span>
          <span class="n">_locals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                                        
          <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;/usr/local/arc5&#39;</span><span class="p">,</span> <span class="s">&#39;share/arc&#39;</span><span class="p">,</span> <span class="s">&#39;job_script.stubs&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stubs</span><span class="p">:</span>
               <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stubs</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                         <span class="k">if</span> <span class="n">do</span> <span class="o">&amp;</span> <span class="n">READ</span><span class="p">:</span>
                              <span class="c"># END of stub</span>
                              <span class="c">#</span>
                              <span class="c"># Save to stubs map</span>
                              <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
                                   <span class="k">if</span> <span class="n">stub_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_stubs</span><span class="p">[</span><span class="n">stub_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">stub</span>
                                   <span class="n">do</span> <span class="o">=</span> <span class="n">PARSE</span>
                         
                              <span class="c"># Encountered loop tag</span>
                              <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>   

                                   <span class="c"># END of loop stub</span>
                                   <span class="c"># </span>
                                   <span class="c"># Loop over the iterable, and for each item:</span>
                                   <span class="c">#   run the macro(s) to resolve the string format variable(s)</span>
                                   <span class="c">#   format the loop stub</span>
                                   <span class="c">#   add formatted loop stub to stub</span>
                                   <span class="k">if</span> <span class="n">do</span> <span class="o">&amp;</span> <span class="n">LOOP</span><span class="p">:</span>
                                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">_iterable</span><span class="p">:</span>
                                             <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_macros</span><span class="p">:</span>
                                                  <span class="n">_locals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">item</span><span class="p">)</span>
                                             <span class="n">stub</span> <span class="o">+=</span> <span class="n">loop</span> <span class="o">%</span> <span class="n">_locals</span>
                                        <span class="n">do</span> <span class="o">^=</span> <span class="n">LOOP</span>

                                   <span class="c"># BEGIN loop stub</span>
                                   <span class="c">#</span>
                                   <span class="c"># Get the iterable and macros to resolve the string format variables</span>
                                   <span class="k">else</span><span class="p">:</span> 
                                        <span class="n">loop</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                                        <span class="n">keys</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                                        <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="n">_iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                        <span class="n">_macros</span> <span class="o">=</span> <span class="p">[]</span>
                                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                                             <span class="k">assert</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;%&#39;</span><span class="p">)</span>
                                             <span class="n">_macros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                                        <span class="n">do</span> <span class="o">|=</span> <span class="n">LOOP</span>

                              <span class="c"># Inside loop. Add line to loop stub. Format later</span>
                              <span class="k">elif</span> <span class="n">do</span> <span class="o">&amp;</span> <span class="n">LOOP</span><span class="p">:</span>
                                   <span class="n">loop</span> <span class="o">+=</span> <span class="n">line</span>
                              <span class="c"># Format line and add to stub</span>
                              <span class="k">else</span><span class="p">:</span>
                                   <span class="n">stub</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span>

                         <span class="k">elif</span> <span class="n">do</span> <span class="o">&amp;</span> <span class="n">SKIP</span><span class="p">:</span>
                              <span class="c"># BEGIN stub</span>
                              <span class="c">#</span>
                              <span class="c"># Everything after the &#39;&gt;&#39; tag is read into the stub string, inlcuding empty lines</span>
                              <span class="n">stub</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                              <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
                                   <span class="n">do</span> <span class="o">=</span> <span class="n">READ</span>

                         <span class="k">elif</span> <span class="n">line</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&gt;&gt;&#39;</span><span class="p">:</span>
                              <span class="c"># Signals that a new stub is coming up</span>
                              <span class="n">stub_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                              <span class="n">stub</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                              <span class="n">do</span> <span class="o">=</span> <span class="n">SKIP</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                         <span class="k">raise</span> <span class="n">ArcError</span><span class="p">(</span><span class="s">&#39;Incomplete format key. Maybe a missing </span><span class="se">\&#39;</span><span class="s">s</span><span class="se">\&#39;</span><span class="s"> after </span><span class="se">\&#39;</span><span class="si">%%</span><span class="s">( ... )</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;common.submit.JobscriptAssembler&#39;</span><span class="p">)</span> 
                    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                         <span class="k">raise</span> <span class="n">ArcError</span><span class="p">(</span><span class="s">&#39;Syntax error at line </span><span class="si">%i</span><span class="s"> in job_script.stubs. Missing </span><span class="se">\&#39;</span><span class="si">%%</span><span class="se">\&#39;</span><span class="s">.&#39;</span>
                                        <span class="o">%</span> <span class="n">num</span><span class="p">,</span> <span class="s">&#39;common.submit.JobscriptAssembler&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                         <span class="k">raise</span> <span class="n">ArcError</span><span class="p">(</span><span class="s">&#39;Unknown key </span><span class="si">%s</span><span class="s"> at line </span><span class="si">%i</span><span class="s"> in job_script.stubs.&#39;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">num</span><span class="p">),</span> <span class="s">&#39;common.submit.JobscriptAssembler&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="JobscriptAssembler.setup_local_transfer"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.JobscriptAssembler.setup_local_transfer">[docs]</a>     <span class="k">def</span> <span class="nf">setup_local_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Create runtime control directory and update job input and output files.</span>
<span class="sd">          RUNTIME_CONTROLDIR is added to the string format map.</span>
<span class="sd">          &quot;&quot;&quot;</span>

          <span class="kn">import</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">shutil</span>
          <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
          <span class="c"># create runtime controldir</span>
          <span class="bp">self</span><span class="p">[</span><span class="s">&#39;RUNTIME_CONTROLDIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;SESSIONDIR&#39;</span><span class="p">],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;control.&#39;</span><span class="p">)</span>

          <span class="n">ctrdir</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">controldir</span>
          <span class="n">local_ctrdir</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;RUNTIME_CONTROLDIR&#39;</span><span class="p">]</span>
          <span class="n">gridid</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;GRIDID&#39;</span><span class="p">]</span>

          <span class="c"># securely copy proxy</span>
          <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">local_ctrdir</span><span class="p">,</span> <span class="s">&#39;job.local.proxy&#39;</span><span class="p">),</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0600</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">local_proxy</span><span class="p">:</span>
               <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">ctrdir</span><span class="p">,</span> <span class="s">&#39;job.</span><span class="si">%s</span><span class="s">.proxy&#39;</span> <span class="o">%</span> <span class="n">gridid</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">proxy</span><span class="p">:</span>
                    <span class="n">local_proxy</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

          <span class="c"># prepare input file</span>
          <span class="n">job_local_input</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">local_ctrdir</span><span class="p">,</span> <span class="s">&#39;job.local.input&#39;</span><span class="p">)</span>
          <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">ctrdir</span><span class="p">,</span> <span class="s">&#39;job.</span><span class="si">%s</span><span class="s">.input&#39;</span> <span class="o">%</span> <span class="n">gridid</span><span class="p">),</span> <span class="n">job_local_input</span><span class="p">)</span>
          <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">job_local_input</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">local_input</span><span class="p">:</span>
               <span class="n">local_input</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">local_ctrdir</span> <span class="o">+</span> <span class="s">&#39; *.*</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
               <span class="n">local_input</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> *.*</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Output</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">gridid</span><span class="p">))</span>
               <span class="n">local_input</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> *.*</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">jd</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">Error</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">gridid</span><span class="p">))</span>

          <span class="c"># add runtime controldir to output</span>
          <span class="n">job_output</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">ctrdir</span><span class="p">,</span> <span class="s">&#39;job.</span><span class="si">%s</span><span class="s">.output&#39;</span> <span class="o">%</span> <span class="n">gridid</span><span class="p">)</span>
          <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">job_output</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
               <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">local_ctrdir</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
          <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job_output</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">local_ctrdir</span><span class="p">,</span> <span class="s">&#39;job.local.output&#39;</span><span class="p">))</span>

          <span class="c"># copy the local file to runtime control dir, else create it</span>
          <span class="k">try</span><span class="p">:</span>
               <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">ctrdir</span><span class="p">,</span> <span class="s">&#39;job.</span><span class="si">%s</span><span class="s">.local&#39;</span> <span class="o">%</span> <span class="n">gridid</span><span class="p">),</span> <span class="n">join</span><span class="p">(</span><span class="n">local_ctrdir</span><span class="p">,</span> <span class="s">&#39;job.local.local&#39;</span><span class="p">))</span>
          <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
               <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">local_ctrdir</span><span class="p">,</span> <span class="s">&#39;job.local.local&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)):</span>
                    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="JobscriptAssembler.setup_cleaning"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.JobscriptAssembler.setup_cleaning">[docs]</a>     <span class="k">def</span> <span class="nf">setup_cleaning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
          <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Setup trash cleaning. No reason to keep trash until gm-kick runs.</span>
<span class="sd">          &quot;&quot;&quot;</span>
          
          <span class="n">output</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">controldir</span> <span class="o">+</span> <span class="s">&#39;/job.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;GRIDID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;.output&#39;</span>
          <span class="k">try</span><span class="p">:</span>
               <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outputfile</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;OUTPUT_LISTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;OUTPUT_FILES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">outputfile</span><span class="p">:</span>
                         <span class="n">name</span> <span class="o">=</span> <span class="p">(</span>
                              <span class="c"># Replace escaped back-slashes (\).                                </span>
                              <span class="c"># Note: Backslash escapes in 2. argument             </span>
                              <span class="c"># are processed. Pattern explained: First </span>
                              <span class="c"># look for escaped backslashes (8x\), then</span>
                              <span class="c"># look for other escaped chars (4x\).</span>
                              <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;</span><span class="se">\\\\\\\\</span><span class="s">|</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">,</span>
                                     <span class="c"># Remove possible remote destination (URL).</span>
                                     <span class="c"># Take spaces and escaping into account.</span>
                                     <span class="c"># URL is the first string which is preceded by</span>
                                     <span class="c"># a space which is not escaped.  </span>
                                     <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;([^</span><span class="se">\\</span><span class="s">](</span><span class="se">\\\\</span><span class="s">)*) .*&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">1&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">.</span>
                                     <span class="c"># Replace escaped spaces and single quotes</span>
                                     <span class="n">replace</span><span class="p">(</span><span class="s">&#39;\ &#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&quot;&#39;</span><span class="se">\\</span><span class="s">&#39;&#39;&quot;</span><span class="p">)</span><span class="o">.</span>
                                     <span class="c"># Strip leading slashes (/). </span>
                                     <span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
                              <span class="p">)</span>
                         <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
                              <span class="bp">self</span><span class="p">[</span><span class="s">&#39;OUTPUT_LISTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                         <span class="k">else</span><span class="p">:</span>
                              <span class="bp">self</span><span class="p">[</span><span class="s">&#39;OUTPUT_FILES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

          <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span> <span class="c"># Skip cleaning, else output files will be deleted</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;clean_scratchdir&#39;</span><span class="p">)</span>
               <span class="n">verbose</span><span class="p">(</span><span class="s">&#39;Failed to read job output file (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">output</span><span class="p">,</span> <span class="s">&#39;common.submit&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="JobscriptAssembler.setup_runtime_env"><a class="viewcode-back" href="../../../python-lrms.html#lrms.common.submit.JobscriptAssembler.setup_runtime_env">[docs]</a>     <span class="k">def</span> <span class="nf">setup_runtime_env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
          <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          For non-shared filesystems, replace sessiondir with local scratchdir</span>
<span class="sd">          in the stdin, stdout and stderr paths.</span>
<span class="sd">          &quot;&quot;&quot;</span>
          
          <span class="bp">self</span><span class="p">[</span><span class="s">&#39;LOCAL_SCRATCHDIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;LOCAL_SCRATCHDIR&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;GRIDID&#39;</span><span class="p">])</span>
          <span class="n">sdir</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;SESSIONDIR&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span>
          <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;STDIN&#39;</span><span class="p">,</span> <span class="s">&#39;STDOUT&#39;</span><span class="p">,</span> <span class="s">&#39;STDERR&#39;</span><span class="p">):</span>
               <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sdir</span><span class="p">):</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;LOCAL_SCRATCHDIR&#39;</span><span class="p">],</span> <span class="n">f</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">sdir</span><span class="p">))</span></div></div>
</pre></div>

    </div>
    
    <DIV>
      <OBJECT type="text/html" data="http//www.nordugrid.org/styles/ngfooter.html" width="100%">
	<center><a href="http//www.nordugrid.org">Nordugrid homepage</a></center>
      </OBJECT>
    </DIV>
  </body>
</html>
